version: "3"

services:
  mynote-db:
    build: ./mynote-db
    image: mynote-db:stable
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_PASSWORD=postgres
    volumes:
      - ./mynote-db/data:/var/lib/postgresql/data
    networks:
      - mynote
  mynote-be:
    build: ./mynote-be
    image: mynote-be:stable
    depends_on:
      - mynote-db
    ports:
      - "10000"
    environment:
      - DB_URL=192.168.0.17
      - DB_PORT=5432
      - APP_DB_USERNAME=postgres
      - APP_DB_PASSWORD=postgres
      - DB_NAME=postgres
    networks:
      - mynote
  mynote-fe:
    build: ./mynote-fe
    image: mynote-fe:stable
    depends_on:
      - mynote-be
    networks:
      - proxy
      - mynote
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mynote.entrypoints=http"
      - "traefik.http.routers.mynote.rule=Host(`mynote.svc.localgalaxy.org`)"
      - "traefik.http.middlewares.mynote-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.mynote.middlewares=mynote-https-redirect"
      - "traefik.http.routers.mynote-secure.entrypoints=https"
      - "traefik.http.routers.mynote-secure.rule=Host(`mynote.svc.localgalaxy.org`)"
      - "traefik.http.routers.mynote-secure.tls=true"
      - "traefik.http.routers.mynote-secure.service=mynote"
      - "traefik.http.services.mynote.loadbalancer.server.port=80"
      - "traefik.docker.network=proxy"
  mynote-lb:
    build: ./mynote-lb
    image: mynote-lb:stable 
    depends_on:
      - mynote-be
    ports:
      - "4000:4000"
    networks:
      - mynote
networks:
  proxy:
    external: true
  mynote:
    external: false
